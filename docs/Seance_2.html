<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Analyse quantitative - M1 Villes et environnements urbains - Séance 2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Analyse quantitative - M1 Villes et environnements urbains</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./Seance_1.html"> 
<span class="menu-text">Séance 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./Seance_2.html" aria-current="page"> 
<span class="menu-text">Séance 2</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#compter-avec-des-variables-catégorielles" id="toc-compter-avec-des-variables-catégorielles" class="nav-link active" data-scroll-target="#compter-avec-des-variables-catégorielles">Compter avec des variables catégorielles</a>
  <ul class="collapse">
  <li><a href="#tri-à-plat-et-tri-croisé" id="toc-tri-à-plat-et-tri-croisé" class="nav-link" data-scroll-target="#tri-à-plat-et-tri-croisé">Tri à plat et tri croisé</a>
  <ul class="collapse">
  <li><a href="#compter-les-effectifs-absolus" id="toc-compter-les-effectifs-absolus" class="nav-link" data-scroll-target="#compter-les-effectifs-absolus">Compter les effectifs absolus</a></li>
  <li><a href="#calculer-les-pourcentages" id="toc-calculer-les-pourcentages" class="nav-link" data-scroll-target="#calculer-les-pourcentages">Calculer les pourcentages</a></li>
  <li><a href="#croiser-des-variables" id="toc-croiser-des-variables" class="nav-link" data-scroll-target="#croiser-des-variables">Croiser des variables</a></li>
  </ul></li>
  <li><a href="#mettre-en-forme-un-tableau" id="toc-mettre-en-forme-un-tableau" class="nav-link" data-scroll-target="#mettre-en-forme-un-tableau">Mettre en forme un tableau</a></li>
  <li><a href="#exercices" id="toc-exercices" class="nav-link" data-scroll-target="#exercices">Exercices</a></li>
  </ul></li>
  <li><a href="#tests-logiques" id="toc-tests-logiques" class="nav-link" data-scroll-target="#tests-logiques">Tests logiques</a>
  <ul class="collapse">
  <li><a href="#exercices-1" id="toc-exercices-1" class="nav-link" data-scroll-target="#exercices-1">Exercices</a></li>
  </ul></li>
  <li><a href="#le-test-du-khi2" id="toc-le-test-du-khi2" class="nav-link" data-scroll-target="#le-test-du-khi2">Le test du Khi2</a></li>
  <li><a href="#le-tidyverse" id="toc-le-tidyverse" class="nav-link" data-scroll-target="#le-tidyverse">Le tidyverse</a>
  <ul class="collapse">
  <li><a href="#filtrer-des-lignes-et-sélectionner-des-colonnes" id="toc-filtrer-des-lignes-et-sélectionner-des-colonnes" class="nav-link" data-scroll-target="#filtrer-des-lignes-et-sélectionner-des-colonnes">Filtrer des lignes et sélectionner des colonnes</a>
  <ul class="collapse">
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter"><code>filter</code></a></li>
  <li><a href="#select" id="toc-select" class="nav-link" data-scroll-target="#select"><code>select</code></a></li>
  </ul></li>
  <li><a href="#créer-une-colonne-et-recoder-sous-conditions" id="toc-créer-une-colonne-et-recoder-sous-conditions" class="nav-link" data-scroll-target="#créer-une-colonne-et-recoder-sous-conditions">Créer une colonne et recoder sous conditions</a>
  <ul class="collapse">
  <li><a href="#mutate" id="toc-mutate" class="nav-link" data-scroll-target="#mutate"><code>mutate</code></a></li>
  <li><a href="#if_else" id="toc-if_else" class="nav-link" data-scroll-target="#if_else"><code>if_else</code></a></li>
  <li><a href="#case_when" id="toc-case_when" class="nav-link" data-scroll-target="#case_when"><code>case_when</code></a></li>
  </ul></li>
  <li><a href="#exercices-2" id="toc-exercices-2" class="nav-link" data-scroll-target="#exercices-2">Exercices</a>
  <ul class="collapse">
  <li><a href="#fct" id="toc-fct" class="nav-link" data-scroll-target="#fct"><code>fct</code></a></li>
  </ul></li>
  <li><a href="#exercices-3" id="toc-exercices-3" class="nav-link" data-scroll-target="#exercices-3">Exercices</a></li>
  <li><a href="#calculer-des-indicateurs-dans-des-sous-groupes" id="toc-calculer-des-indicateurs-dans-des-sous-groupes" class="nav-link" data-scroll-target="#calculer-des-indicateurs-dans-des-sous-groupes">Calculer des indicateurs dans des sous-groupes</a>
  <ul class="collapse">
  <li><a href="#summarize-et-.by" id="toc-summarize-et-.by" class="nav-link" data-scroll-target="#summarize-et-.by">Summarize et .by</a></li>
  </ul></li>
  <li><a href="#exercices-4" id="toc-exercices-4" class="nav-link" data-scroll-target="#exercices-4">Exercices</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Séance 2</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="compter-avec-des-variables-catégorielles" class="level1">
<h1>Compter avec des variables catégorielles</h1>
<p>Vous travaillez ici avec les données du recensement anonymisées, publiées sous forme d’un fichier comportant une ligne par individu. La base <code>rp</code> correspond au recensement de 2017 pour la ville de Lyon. Le dictionnaire des codes est disponible à <a href="https://www.insee.fr/fr/statistiques/4802064?sommaire=4508161#dictionnaire">cette adresse</a>.</p>
<section id="tri-à-plat-et-tri-croisé" class="level2">
<h2 class="anchored" data-anchor-id="tri-à-plat-et-tri-croisé">Tri à plat et tri croisé</h2>
<section id="compter-les-effectifs-absolus" class="level3">
<h3 class="anchored" data-anchor-id="compter-les-effectifs-absolus">Compter les effectifs absolus</h3>
<p>La fonction <code>table</code> fait partie des fonctions intégrées au R de base. Elle permet de réaliser des tris à plat sur un vecteur et des tris croisés sur deux vecteurs.</p>
<p>Le tableau <code>rp</code> contient une colonne <code>sexe</code> qui correspond à la variable qui vaut 1 si l’individu recensé est un homme et 2 si l’individu est une femme. On peut compter le nombre d’hommes et de femmes :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(rp<span class="sc">$</span>sexe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     1      2 
 90962 102985 </code></pre>
</div>
</div>
<p>On peut aussi connaître le nombre de personnes en couple grâce à la colonne <code>couple</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(rp<span class="sc">$</span>couple)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     1      2 
 76546 117401 </code></pre>
</div>
</div>
<p>Quand les données sont livrées avec des poids d’échantillonnage, on peut utiliser la fonction <code>wtd.table</code> pour calculer des effectifs pondérés.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wtd.table</span>(rp<span class="sc">$</span>sexe, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1        2 
242020.5 274039.1 </code></pre>
</div>
</div>
</section>
<section id="calculer-les-pourcentages" class="level3">
<h3 class="anchored" data-anchor-id="calculer-les-pourcentages">Calculer les pourcentages</h3>
<p>Souvent, on cherche plutôt à obtenir des pourcentages que des effectifs absolus. La fonction <code>proportions</code> permet de calculer la part associée chaque modalité de la variable. Elle s’applique à l’objet créé par la fonction <code>table</code>.</p>
<p>La part d’hommes/de femmes dans la population du département du Rhône</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>tab_sexe <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(rp<span class="sc">$</span>sexe, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">proportions</span>(tab_sexe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        1         2 
0.4689777 0.5310223 </code></pre>
</div>
</div>
<p>La part de personnes en couple</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>tab_couple <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(rp<span class="sc">$</span>couple, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">proportions</span>(tab_couple)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        1         2 
0.4011596 0.5988404 </code></pre>
</div>
</div>
<p>On peut encore modifier ce tableau pour faciliter la lecture, par exemple en convertissant cette proportion en pourcentages</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># En décomposant ligne par ligne</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>tab_sexe <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(rp<span class="sc">$</span>sexe, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>tab_sexe <span class="ot">&lt;-</span> <span class="fu">proportions</span>(tab_sexe)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>tab_sexe <span class="ot">&lt;-</span> tab_sexe<span class="sc">*</span><span class="dv">100</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>tab_sexe <span class="ot">&lt;-</span> <span class="fu">round</span>(tab_sexe, <span class="dv">2</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>tab_sexe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   1    2 
46.9 53.1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># En cumulant les fonctions</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>tab_sexe <span class="ot">&lt;-</span> <span class="fu">proportions</span>(<span class="fu">wtd.table</span>(rp<span class="sc">$</span>sexe, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>tab_sexe <span class="ot">&lt;-</span> <span class="fu">round</span>(tab_sexe<span class="sc">*</span><span class="dv">100</span>, <span class="dv">2</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>tab_sexe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   1    2 
46.9 53.1 </code></pre>
</div>
</div>
</section>
<section id="croiser-des-variables" class="level3">
<h3 class="anchored" data-anchor-id="croiser-des-variables">Croiser des variables</h3>
<p>Pour croiser deux variables, il suffit d’ajouter la deuxième colonne comme deuxième argument. La part d’hommes et de femmes en couple :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>tab_sexe_couple <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(rp<span class="sc">$</span>sexe, rp<span class="sc">$</span>couple, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>tab_sexe_couple</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         1        2
1 104684.8 137335.7
2 102337.5 171701.6</code></pre>
</div>
</div>
<p>Pour les tableaux croisés, les fonctions <code>lprop</code> et <code>cprop</code> du package <code>questionr</code> permettent d’obtenir très facilement les pourcentages en ligne ou en colonne ainsi que les marges.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rprop</span>(tab_sexe_couple)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    1     2     Total
1    43.3  56.7 100.0
2    37.3  62.7 100.0
All  40.1  59.9 100.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cprop</span>(tab_sexe_couple)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      1     2     All  
1      50.6  44.4  46.9
2      49.4  55.6  53.1
Total 100.0 100.0 100.0</code></pre>
</div>
</div>
</section>
</section>
<section id="mettre-en-forme-un-tableau" class="level2">
<h2 class="anchored" data-anchor-id="mettre-en-forme-un-tableau">Mettre en forme un tableau</h2>
<p>La mise en forme des tableaux sur R et leur exportation demande de nombreuses étapes supplémentaires. Le plus simple pour vous reste de construire votre tableau en recopiant à la main les valeurs sans faire d’erreurs, ou bien utiliser la fonction View() et copier coller les valeurs dans un logiciel de traitement de texte (Word ou Libre Office Writer) ou un tableur (Excel ou Libre Office Calc). N’oubliez pas d’ajouter les parts dans l’ensemble de la population pour comparer. Nous verrons dans la prochaine séance des packages supplémentaires pour le faire directement dans R.</p>
</section>
<section id="exercices" class="level2">
<h2 class="anchored" data-anchor-id="exercices">Exercices</h2>
<ol type="1">
<li>Déterminez la part de la population qui est étudiante (= lyonnais·es qui sont inscrit·es dans un établissement d’enseignement supérieur)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># On calcul les effectifs avec un tri à plat</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>tab_etud <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(rp<span class="sc">$</span>etud, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Puis la proportion</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">proportions</span>(tab_etud)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        1         2 
0.2914641 0.7085359 </code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Déterminez pour les hommes et pour les femmes la part d’étudiant·es</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># On calcul les effectifs avec un tri croisé</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>tab_etud <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(rp<span class="sc">$</span>sexe, rp<span class="sc">$</span>etud, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Puis la proportion</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rprop</span>(tab_etud)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    1     2     Total
1    28.8  71.2 100.0
2    29.5  70.5 100.0
All  29.1  70.9 100.0</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Déterminez la part de femmes et d’hommes chez les étudiant·es et chez les non étudiant·es</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># On calcul les effectifs avec un tri croisé en inversant les variables</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>tab_etud <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(rp<span class="sc">$</span>etud, rp<span class="sc">$</span>sexe, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Puis la proportion</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rprop</span>(tab_etud)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    1     2     Total
1    46.3  53.7 100.0
2    47.1  52.9 100.0
All  46.9  53.1 100.0</code></pre>
</div>
</div>
</section>
</section>
<section id="tests-logiques" class="level1">
<h1>Tests logiques</h1>
<p>L’essentiel du recodage s’opère avec des instructions logiques simples (égal, différent, inférieur ou supérieur à) que l’on peut combiner sur une variable ou plusieurs variables). On utilise pour cela des tests.</p>
<p>Un test est une opération logique de comparaison qui renvoie vrai (<code>TRUE</code>) ou faux (<code>FALSE</code>) pour chacun des éléments d’un vecteur.</p>
<p>Parmi les opérateurs de comparaison disponibles, on trouve notamment&nbsp;:</p>
<ul>
<li><code>==</code> qui teste l’égalité</li>
<li><code>!=</code> qui teste la différence</li>
<li><code>&gt;</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;=</code> qui testent la supériorité ou l’infériorité</li>
<li><code>%in%</code> qui teste l’appartenance à un ensemble de valeurs</li>
</ul>
<p>Exemple le plus simple&nbsp;:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="sc">==</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="sc">!=</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Exemple appliqué à un vecteur&nbsp;:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>x <span class="sc">&lt;</span> <span class="dv">5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE</code></pre>
</div>
</div>
<p>On peut combiner plusieurs tests avec les opérateurs logiques <em>et</em> (<code>&amp;</code>) et <em>ou</em> (<code>|</code>). Ainsi, si on veut tester qu’une valeur est comprise entre 3 et 6 inclus, on peut faire&nbsp;:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>x <span class="sc">&gt;=</span> <span class="dv">3</span> <span class="sc">&amp;</span> x <span class="sc">&lt;=</span> <span class="dv">6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] FALSE FALSE  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE</code></pre>
</div>
</div>
<p>Si on veut tester qu’une valeur est égale à “Bleu” ou à “Vert”, on peut faire&nbsp;:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Jaune"</span>, <span class="st">"Jaune"</span>, <span class="st">"Rouge"</span>, <span class="st">"Vert"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>vec <span class="sc">==</span> <span class="st">"Jaune"</span> <span class="sc">|</span> vec <span class="sc">==</span> <span class="st">"Vert"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE  TRUE FALSE  TRUE</code></pre>
</div>
</div>
<p>À noter que dans ce cas, on peut utiliser l’opérateur <code>%in%</code><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, qui teste si une valeur fait partie des éléments d’un vecteur&nbsp;:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>vec <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Jaune"</span>, <span class="st">"Vert"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  TRUE  TRUE FALSE  TRUE</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Attention, si on souhaite tester si une valeur <code>x</code> est inconnue (ou ‘manquante’), c’est-à-dire si elle est codée <code>NA</code> (<em>Not Available</em>), faire le test <code>x == NA</code> <em>ne donnera pas le résultat escompté</em>. En effet, fidèle à sa réputation de rigueur informaticienne, pour R <code>NA == NA</code> ne vaut pas <code>TRUE</code> mais… <code>NA</code> (on ne sait pas si une valeur inconnue est égale à une autre valeur inconnue).</p>
<p>Pour tester si une valeur est inconnue (<code>NA</code>), il faut utiliser la fonction dédiée <code>is.na</code> et faire <code>is.na(x)</code>.</p>
<p>Cependant, par convention, <code>NA %in% NA</code> vaut <code>TRUE</code>.</p>
</div>
</div>
<p>Enfin, on peut inverser un test avec l’opérateur <em>non</em> (<code>!</code>)&nbsp;:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="sc">!</span>(vec <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Jaune"</span>, <span class="st">"Vert"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE FALSE  TRUE FALSE</code></pre>
</div>
</div>
<section id="exercices-1" class="level2">
<h2 class="anchored" data-anchor-id="exercices-1">Exercices</h2>
<p>Appliquez un test sur les habitant·es de Lyon qui vérifie si ils et elles sont :</p>
<ol type="1">
<li>Immigré·es</li>
<li>Immigré·es et majeur·es</li>
<li>Immgré·es marié·es ou pacsé·es</li>
<li>Immigré·es français·es marié·es ou pacsé</li>
<li>Immigré·es français marié·es ou immigré·es étranger·es pacsé·es</li>
<li>Immigré·es pas propriétaires</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>rp<span class="sc">$</span>immi <span class="sc">==</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
[13] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[25] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[37] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[49] FALSE FALSE
 [ reached getOption("max.print") -- omitted 193897 entries ]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>rp<span class="sc">$</span>immi <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  rp<span class="sc">$</span>agerev <span class="sc">&gt;</span> <span class="dv">17</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
[13] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[25] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[37] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[49] FALSE FALSE
 [ reached getOption("max.print") -- omitted 193897 entries ]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 </span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>rp<span class="sc">$</span>immi <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  rp<span class="sc">$</span>stat_conj <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[13] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[25] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[37] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[49] FALSE FALSE
 [ reached getOption("max.print") -- omitted 193897 entries ]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 4</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>rp<span class="sc">$</span>immi <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  rp<span class="sc">$</span>stat_conj <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span> <span class="sc">&amp;</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  rp<span class="sc">$</span>inatc <span class="sc">==</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[13] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[25] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[37] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[49] FALSE FALSE
 [ reached getOption("max.print") -- omitted 193897 entries ]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 5</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>(rp<span class="sc">$</span>immi <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  rp<span class="sc">$</span>stat_conj <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    rp<span class="sc">$</span>inatc <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  (rp<span class="sc">$</span>immi <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  rp<span class="sc">$</span>stat_conj <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  rp<span class="sc">$</span>inatc <span class="sc">==</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[13] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[25] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[37] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[49] FALSE FALSE
 [ reached getOption("max.print") -- omitted 193897 entries ]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 6</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>rp<span class="sc">$</span>immi <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  rp<span class="sc">$</span>stocd <span class="sc">!=</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
[13] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE  TRUE FALSE
[25] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[37] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[49] FALSE FALSE
 [ reached getOption("max.print") -- omitted 193897 entries ]</code></pre>
</div>
</div>
</section>
</section>
<section id="le-test-du-khi2" class="level1">
<h1>Le test du Khi2</h1>
<p>Le test du Khi2 peut être obtenu à l’aide de la fonction <code>chisq.test</code>. Il suffit de mettre comme arguments les deux colonnes que l’on veut croiser pour tester leur indépendance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tableau croisé du sexe et de la pratique religieuse</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>tab_loisir <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(hdv2003<span class="sc">$</span>sexe, hdv2003<span class="sc">$</span>relig, <span class="at">weights =</span> hdv2003<span class="sc">$</span>poids)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rprop</span>(tab_loisir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Pratiquant regulier Pratiquant occasionnel Appartenance sans pratique
Homme   8.9                19.9                   39.8                     
Femme  15.6                23.4                   36.3                     
All    12.5                21.8                   37.9                     
      Ni croyance ni appartenance Rejet NSP ou NVPR Total
Homme  24.2                         6.1   1.2       100.0
Femme  18.8                         3.5   2.4       100.0
All    21.3                         4.7   1.9       100.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test du Khi2 du sexe et du loisir</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chisq.test</span>(hdv2003<span class="sc">$</span>sexe, hdv2003<span class="sc">$</span>relig)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's Chi-squared test

data:  hdv2003$sexe and hdv2003$relig
X-squared = 41.973, df = 5, p-value = 5.964e-08</code></pre>
</div>
</div>
<p>Dans le cas où une pondération est présente, il est nécessaire de recourir au package <code>survey</code>. Son fonctionnement est particulier, un exemple minimal est donc présenté ici pour le cas d’un test du Khi2 opéré pour un plan d’échantillonnage simple (on précise juste des poids de sondage).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"survey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Installing package into '/usr/local/lib/R/site-library'
(as 'lib' is unspecified)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: grid</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Matrix'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:tidyr':

    expand, pack, unpack</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: survival</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'survey'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:graphics':

    dotchart</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># On crée un "design" qui associe les données et leur plan d'échantillonnage</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>hdv2003w <span class="ot">&lt;-</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">svydesign</span>(</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># On précise les données</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ici, notre tableau hdv2003</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> hdv2003,</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Un argument obligatoire qui n'est pas détaillé ici</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">ids =</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># On précise la colonne des poids</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> hdv2003<span class="sc">$</span>poids</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="co"># On utilise la fonction du Khi2 en créant une formule</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="fu">svychisq</span>(</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># D'abord la formule des deux variables à croiser</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> sexe<span class="sc">+</span>relig,</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Puis le design</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">design =</span> hdv2003w</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Pearson's X^2: Rao &amp; Scott adjustment

data:  svychisq(~sexe + relig, design = hdv2003w)
F = 5.0914, ndf = 4.9662, ddf = 9927.3678, p-value = 0.0001203</code></pre>
</div>
</div>
</section>
<section id="le-tidyverse" class="level1">
<h1>Le tidyverse</h1>
<p>Le terme <em>tidyverse</em> est une contraction de <em>tidy</em> (qu’on pourrait traduire par “bien rangé”) et de <em>universe</em>. Il s’agit en fait d’une collection d’extensions conçues pour travailler ensemble et basées sur une philosophie commune :</p>
<ul>
<li><code>ggplot2</code> (visualisation)</li>
<li><code>dplyr</code> (manipulation des données)</li>
<li><code>tidyr</code> (remise en forme des données)</li>
<li><code>purrr</code> (programmation)</li>
<li><code>readr</code> (importation de données)</li>
<li><code>tibble</code> (tableaux de données)</li>
<li><code>forcats</code> (variables qualitatives)</li>
<li><code>stringr</code> (chaînes de caractères)</li>
<li><code>lubridate</code> (manipulation de dates)</li>
</ul>
<p>Un des objectifs de ces extensions est de fournir des fonctions avec une syntaxe cohérente, qui fonctionnent bien ensemble, et qui retournent des résultats prévisibles. Nous allons recourrir à cette syntaxe pour transformer nos données.</p>
<section id="filtrer-des-lignes-et-sélectionner-des-colonnes" class="level2">
<h2 class="anchored" data-anchor-id="filtrer-des-lignes-et-sélectionner-des-colonnes">Filtrer des lignes et sélectionner des colonnes</h2>
<section id="filter" class="level3">
<h3 class="anchored" data-anchor-id="filter"><code>filter</code></h3>
<p><code>filter</code> sélectionne des lignes d’une table selon une condition. On lui passe en paramètre un test, et seules les lignes pour lesquelles ce test renvoie <code>TRUE</code> (vrai) sont conservées. On réutilise donc les opérateurs logiques vus dans le cas des tests. Puisque le premier argument est le tableau en lui-même, il n’est plus nécessaire d’utiliser l’opérateur <code>$</code> et il suffit d’utiliser le nom dans colonnes pour filter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtre pour sélectionner les femmes</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>rp_f <span class="ot">&lt;-</span> <span class="fu">filter</span>(rp, sexe <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtre pour sélectionner les femmes immigrées</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>rp_f <span class="ot">&lt;-</span> <span class="fu">filter</span>(rp, sexe <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> immi <span class="sc">==</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On peut également placer des fonctions dans les tests, qui nous permettent par exemple de sélectionner les personnes qui sont plus âgées que l’âge médian.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>rp_senior <span class="ot">&lt;-</span> <span class="fu">filter</span>(rp, agerev <span class="sc">&gt;</span> <span class="fu">median</span>(agerev))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="select" class="level3">
<h3 class="anchored" data-anchor-id="select"><code>select</code></h3>
<p><code>select</code> permet de sélectionner des colonnes d’un tableau de données.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sélectionner uniquement les colonnes du sexe et de l'âge</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(rp, sexe, agerev)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         sexe agerev
        &lt;int&gt;  &lt;int&gt;
     1:     1     25
     2:     2     28
     3:     2      2
     4:     2     30
     5:     1     33
    ---             
193943:     1     18
193944:     1     18
193945:     1     18
193946:     2     18
193947:     1     18</code></pre>
</div>
</div>
<p>Si on fait précéder le nom d’un <code>-</code>, la colonne est éliminée plutôt que sélectionnée&nbsp;:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sélectionner toutes les colonnes sauf le sexe et l'âge</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(rp, <span class="sc">-</span>sexe, <span class="sc">-</span>agerev)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        cantville  nummi  achlr  aemmr  aged ager20 agerevq  anai  anemr   apaf
          arm  ascen   bain   bati catiris   catl catpc   chau   chfl   chos
          clim   cmbl couple   cs1   cuis  dept  derou   dipl   dnai    eau
         egoul   elec   empl  etud   garl   hlml iletud    ilt  immi  inai
        inatc  infam  inper inperf    ipondi   iran      iris  lienf   lprf
          lprm metrodom  moco  modv   na17    na5 naidt   nbpi ne17fr ne24fr
         ne3fr  ne5fr  nenfr  nperr   numf oridt   rech region   sani sanidom
           sfm statr stat_conj  stocd   surf  tact tactd16     tp  trans triris
          typc  typfc   typl  typmc  typmr   voit     wc
 [ reached getOption("max.print") -- omitted 12 rows ]</code></pre>
</div>
</div>
</section>
</section>
<section id="créer-une-colonne-et-recoder-sous-conditions" class="level2">
<h2 class="anchored" data-anchor-id="créer-une-colonne-et-recoder-sous-conditions">Créer une colonne et recoder sous conditions</h2>
<section id="mutate" class="level3">
<h3 class="anchored" data-anchor-id="mutate"><code>mutate</code></h3>
<p>La fonction <code>mutate</code> permet de créer une nouvelle colonne. C’est une alternative à la méthode de base avec l’opétaeur $. Le premier type de recodage consiste à changer la nature d’une colonne. On vérifie la nature d’une colonne avec la fonction <code>class</code> et on peut la modifier avec les fonctions de la forme <code>as.nature_désirée</code> : <code>as.integer</code>, <code>as.character</code> etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier la nature de la variable</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(rp<span class="sc">$</span>agerev)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "integer"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># On transforme cette colonne en format texte</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Ancienne solution avec l'opérateur $</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>rp<span class="sc">$</span>agerev_txt <span class="ot">&lt;-</span> <span class="fu">as.character</span>(rp<span class="sc">$</span>agerev)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(rp<span class="sc">$</span>agerev_txt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Nouvelle solution avec la fonction mutate</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Attention : on transforme le tableau de données, plus seulement une colonne</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># À nouveau, on fait directement référence au nom des colonnes</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Le premier argument est le tableau à modifié</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Le deuxième la variable à créer : son nom puis son contenu</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">agerev_txt =</span> <span class="fu">as.character</span>(agerev)</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="if_else" class="level3">
<h3 class="anchored" data-anchor-id="if_else"><code>if_else</code></h3>
<p>La fonction <code>if_else</code> permet de faire une action sous condition : si l’âge est supérieur à 18, donne la valeur “majeur.e”, sinon donne la valeur “mineur.e”. case_when étend ce fonctionnement à plus d’une possibilité : si l’âge est supérieur à 18 donne “majeur.e”, si l’âge est compris entre 18 et 64 donne “adulte”, si l’âge est supérieur à 64 donne “senior”.</p>
<p>On pourra dire à R : crée une nouvelle colonne (<code>mutate</code>) à partir d’un test sur la valeur initiale de la variable (<code>if_else</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Voici deux versions du codage de l'âge des personnes recensées, soit la variable agerev. La première est lisible, la deuxième est commentée ligne par ligne.</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Version plus lisible sans les commentaires</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span> <span class="fu">mutate</span>(</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  rp,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_rec =</span> </span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">if_else</span>(</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>      agerev <span class="sc">&gt;</span> <span class="dv">17</span>,</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Majeur.e"</span>,</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Mineur.e"</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Version commentée</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># J'utilise la fonction mutate pour créer une colonne</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Le premier argument de mutate, le tableau à transformer</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Le deuxième argument de mutate, le nom de la colonne à créer (à gauche du =) et la valeur que je lui donne (à droite du =)</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_rec =</span> </span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Elle sera créée à l'aide du test opérée par la fonction ifelse</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">if_else</span>(</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Le premier argument de ifelse, la condition</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>        agerev <span class="sc">&gt;</span> <span class="dv">17</span>,</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Le deuxième argument de ifelse, la valeur à donner si la condition est vérifiée</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Majeur.e"</span>, </span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Le troisième argument de ] ifelse, la valeur à donner si la condition n'est pas vérifié</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Mineur.e"</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Je ferme la parenthèse de la fonction if_else</span></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Je ferme la parenthèse de la fonction mutate</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a><span class="co"># On obtient bien une nouvelle variable/colonne nommée age_rec qui prend soit la valeur "Mineur.e", soit la valeur "Majeur.e"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="case_when" class="level3">
<h3 class="anchored" data-anchor-id="case_when"><code>case_when</code></h3>
<p>Dès qu’on veut utiliser plus d’un test (par exemple, obtenir trois valeurs : mineur.e, adulte, senior), il faut utiliser la fonction case_when.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Version lisible</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span> </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  rp,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_rec =</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">case_when</span>(</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>      agerev <span class="sc">&lt;</span> <span class="dv">18</span> <span class="sc">~</span> <span class="st">"Mineur.e"</span>,</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>      agerev <span class="sc">&gt;</span> <span class="dv">17</span> <span class="sc">&amp;</span> agerev <span class="sc">&lt;</span> <span class="dv">65</span> <span class="sc">~</span> <span class="st">"Adulte"</span>,</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>      agerev <span class="sc">&gt;</span> <span class="dv">64</span> <span class="sc">~</span> <span class="st">"Senior"</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Version commentée</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Je crée une variable grâce à la fonction mutat</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Le premier argument, je transforme le tableau rp</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Le deuxième argument, la variable à créer</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_rec =</span> </span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Qui sera créee grâce à la fonction case_when</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># À gauche du "~", c'est la condition, à droite la valeur</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Si agerev est strictement inférieur à 18, alors la variable prendra la valeur "Mineur.e"</span></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>        agerev <span class="sc">&lt;</span> <span class="dv">18</span> <span class="sc">~</span> <span class="st">"Mineur.e"</span>,</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Si agerev est strictement supérieur à 17 ET qu'agerev est strictement inférieur à 65, alors la variable prendra la valeur "Adulte"</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>        agerev <span class="sc">&gt;</span> <span class="dv">17</span> <span class="sc">&amp;</span> agerev <span class="sc">&lt;</span> <span class="dv">65</span> <span class="sc">~</span> <span class="st">"Adulte"</span>,</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Si agerev est strictement supérieur à 64, alors la variable prendra la valeur "Senior"</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>        agerev <span class="sc">&gt;</span> <span class="dv">64</span> <span class="sc">~</span> <span class="st">"Senior"</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Je ferme la parenthèse de la fonction case_when</span></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Je ferme la parenthèse de la fonction mutate</span></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="exercices-2" class="level2">
<h2 class="anchored" data-anchor-id="exercices-2">Exercices</h2>
<ol type="1">
<li>Créez une nouvelle variable (colonne) qui vaut 1 si l’individu est propriétaire et 0 sinon.</li>
<li>Créez une nouvelle variable qui vaut 1 si l’individu est logé dans le secteur libre et 0 si l’individu est logé dans le secteur HLM.</li>
<li>Créez un nouveau tableau de données <code>rp_prop</code> qui ne contient que les individus propriétaires. Faites de même avec <code>rp_hlm</code> qui ne contient que les individus du secteur HLM.</li>
<li>Calculez la part de propriétaires à Lyon. Calculez la part de personnes logées dans le secteur HLM.</li>
<li>Créez une nouvelle variable dont les trois modalités seront d’être propriétaire, d’être locataire et d’être locataire HLM.</li>
<li>Calculez les effectifs et les parts de chacun de ces trois statuts d’occupation.</li>
<li>Créez une variable catégorielle synthétique qui croise le genre et le statut d’occupation du logement.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop =</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">if_else</span>(</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>        stocd <span class="sc">==</span> <span class="dv">10</span>,</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>,</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 2</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span> </span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">libre =</span> </span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">if_else</span>(</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>        stocd <span class="sc">!=</span> <span class="dv">22</span>,</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>,</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span></span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 3</span></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>rp_prop <span class="ot">&lt;-</span> <span class="fu">filter</span>(rp, prop <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>rp_hlm <span class="ot">&lt;-</span> <span class="fu">filter</span>(rp, libre <span class="sc">!=</span> <span class="dv">1</span>)</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 4</span></span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>tab_prop <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(rp<span class="sc">$</span>prop, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi)</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a><span class="fu">proportions</span>(tab_prop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       0        1 
0.642252 0.357748 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>tab_libre <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(rp<span class="sc">$</span>libre, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">proportions</span>(tab_libre)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        0         1 
0.1865278 0.8134722 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 5</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span> </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat_occ =</span> </span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        stocd <span class="sc">==</span> <span class="dv">10</span> <span class="sc">~</span> <span class="st">"Propriétaire"</span>,</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>        stocd <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">23</span>, <span class="dv">30</span>) <span class="sc">~</span> <span class="st">"Locataire"</span>,</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>        stocd <span class="sc">==</span> <span class="dv">22</span> <span class="sc">~</span> <span class="st">"Locataire HLM"</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 6</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>tab_stat_occ <span class="ot">&lt;-</span> <span class="fu">wtd.table</span>(rp<span class="sc">$</span>stat_occ, <span class="at">weights =</span> rp<span class="sc">$</span>ipondi, <span class="at">useNA =</span> <span class="st">"always"</span>)</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="fu">proportions</span>(tab_stat_occ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Locataire Locataire HLM  Propriétaire          &lt;NA&gt; 
   0.42592401    0.18652782    0.35774796    0.02980021 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 7</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">occ_genre =</span> </span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>        stat_occ <span class="sc">==</span> <span class="st">"Locataire"</span> <span class="sc">&amp;</span> sexe <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Homme locataire"</span>,</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>        stat_occ <span class="sc">==</span> <span class="st">"Propriétaire"</span> <span class="sc">&amp;</span> sexe <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Homme propriétaire"</span>,</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>        stat_occ <span class="sc">==</span> <span class="st">"Locataire HLM"</span> <span class="sc">&amp;</span> sexe <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Homme locataire HLM"</span>,</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>        stat_occ <span class="sc">==</span> <span class="st">"Locataire"</span> <span class="sc">&amp;</span> sexe <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Femme locataire"</span>,</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>        stat_occ <span class="sc">==</span> <span class="st">"Propriétaire"</span> <span class="sc">&amp;</span> sexe <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Femme propriétaire"</span>,</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>         stat_occ <span class="sc">==</span> <span class="st">"Locataire HLM"</span> <span class="sc">&amp;</span> sexe <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Femme locataire HLM"</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">occ_genre =</span> <span class="fu">fct</span>(occ_genre,</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Homme propriétaire"</span>,</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Homme locataire"</span>,</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Homme locataire HLM"</span>,</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Femme propriétaire"</span>,</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Femme locataire"</span>,</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Femme locataire HLM"</span>))</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fct" class="level3">
<h3 class="anchored" data-anchor-id="fct"><code>fct</code></h3>
<p>Nous n’avons pas spécifié la nature de notre nouvelle colonne/vecteur. On cherche ici à créer un facteur puisqu’on a une variable catégorielle. La fonction <code>fct</code> permet de créer un vecteur et de spécifier l’ordre de ses modalités (quand on fera des tableaux ou des graphiques, on voudra que “Senior” apparaisse en dernier, et non entre “Mineur.e” et “Majeur.e”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Un vecteur de type texte qui renseigne la catégorie d'âge de 6 personnes</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>cat_age <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Mineur.e"</span>, </span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Adulte"</span>, </span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Adulte"</span>, </span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Senior"</span>, </span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Mineur.e"</span>,</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Senior"</span>)</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Le tri croisé ne donne pas quelque chose d'intuitif :</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(cat_age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>cat_age
  Adulte Mineur.e   Senior 
       2        2        2 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># La catégorie adulte apparaît avant mineur.e</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="co"># On le transforme en facteur</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>cat_age <span class="ot">&lt;-</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct</span>(</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Le premier argument, le facteur à transformer</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    cat_age, </span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Le deuxième argument, les modalités (levels) avec l'ordre d'apparition</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span>  <span class="fu">c</span>(<span class="st">"Mineur.e"</span>, <span class="st">"Adulte"</span>, <span class="st">"Senior"</span>)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Le problème est résolu</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(cat_age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>cat_age
Mineur.e   Adulte   Senior 
       2        2        2 </code></pre>
</div>
</div>
<p>Finalement, la fonction <code>irec</code> permet de réaliser le recodage d’une variable catégorielle par le biais d’une interface. Elle vous permet de changer les modalités d’une variable, par exemple passer d’un codage numérique aux étiquettes en texte, en faisant appel à la fonction <code>fct_recode</code>. Elle n’est à lancer qu’une fois pour obtenir le code et peut être retirée par la suite.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recodage interactif de la variable sexe</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">irec</span>(rp<span class="sc">$</span>sexe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Recoding rp$sexe into rp$sexe_rec</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>rp<span class="sc">$</span>sexe_rec <span class="ot">&lt;-</span> rp<span class="sc">$</span>sexe <span class="sc">%&gt;%</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.character</span>() <span class="sc">%&gt;%</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fct_recode</span>(</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hommes"</span> <span class="ot">=</span> <span class="st">"1"</span>,</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Femmes"</span> <span class="ot">=</span> <span class="st">"2"</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="exercices-3" class="level2">
<h2 class="anchored" data-anchor-id="exercices-3">Exercices</h2>
<ol type="1">
<li><p>Créez une variable catégorielle appelée <code>immigre</code> à deux modalités : Immigré/Non immigré</p></li>
<li><p>Créez une variable catégorielle <code>stat_immi</code> à trois modalités : Immigré étranger/immigré français/français non immigré</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">immigre =</span> </span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct</span>(</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">if_else</span>(immi <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Immigré"</span>, <span class="st">"Non immigré"</span>),</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Immigré"</span>, <span class="st">"Non immigré"</span>)</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 2</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat_immi =</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fct</span>(</span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">case_when</span>(</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>          immi <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> inatc <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Immigré étranger"</span>,</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>          immi <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> inatc <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Immigré français"</span>,</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>          immi <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Français non immigré"</span></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Immigré étranger"</span>,</span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Immigré français"</span>,</span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Français non immigré"</span>)</span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculer-des-indicateurs-dans-des-sous-groupes" class="level2">
<h2 class="anchored" data-anchor-id="calculer-des-indicateurs-dans-des-sous-groupes">Calculer des indicateurs dans des sous-groupes</h2>
<p>Les opérations de comparaison d’indicateurs impliquent qu’il faille répéter le même calcul au sein de sous-groupes distincts. Deux fonctions permettront d’aboutir à un tel résultat.</p>
<section id="summarize-et-.by" class="level3">
<h3 class="anchored" data-anchor-id="summarize-et-.by">Summarize et .by</h3>
<p>La fonction <code>summarize</code> permet d’obtenir un tableau synthétique qui recense le résultat d’opérations de calcul. Elle s’utilise avec l’argument <code>.by</code> qui définit dans quelles sous-populations le logiciel doit travailler : chez les hommes puis chez les femmes (distinguées par la variable <code>sexe</code>), par arrondissements (distingués par la variable <code>arm</code>) etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># La moyenne d'âge des lyonnais·es</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(rp<span class="sc">$</span>agerev)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 35.97611</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># La fonction summarize sans groupes spécifiés par .by</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize</span>(rp, </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">age_m =</span> <span class="fu">mean</span>(agerev))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     age_m
1 35.97611</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># On obtient 1 seule ligne : la moyenne d'âge des lyonnais·es</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="co"># La fonction summarize avec groupes spécifiés par .by</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize</span>(rp, </span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">age_m =</span> <span class="fu">mean</span>(agerev),</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">.by =</span> sexe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  sexe    age_m
1    1 34.75168
2    2 37.05759</code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># On obtient 2 lignes : l'âge moyen des femmes et des hommes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>L’argument <code>.by</code> peut aussi être un argument de la fonction <code>mutate</code>. On peut par exemple vouloir créer une colonne qui ajoute une variable à chaque individu renseignant la valeur prise par le sous-groupes. Par exemple, l’âge moyen dans le groupe définit par le sexe, pour ensuite faire l’écart entre l’âge de l’individu et l’âge moyen des personnes de même sexe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer une colonne qui renseigne l'âge moyen dans le sous-groupe de sexe</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span> </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_m =</span> <span class="fu">mean</span>(agerev),</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> sexe)</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier le résultat</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>rp<span class="sc">$</span>age_m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 34.75168 37.05759 37.05759 37.05759 34.75168 37.05759 37.05759 37.05759
 [9] 34.75168 37.05759 37.05759 37.05759 37.05759 34.75168 37.05759 34.75168
[17] 37.05759 34.75168 37.05759 34.75168 34.75168 37.05759 37.05759 34.75168
[25] 34.75168 37.05759 34.75168 37.05759 34.75168 34.75168 34.75168 34.75168
[33] 37.05759 34.75168 37.05759 34.75168 37.05759 37.05759 34.75168 37.05759
[41] 37.05759 34.75168 37.05759 34.75168 37.05759 34.75168 34.75168 34.75168
[49] 34.75168 37.05759
 [ reached getOption("max.print") -- omitted 193897 entries ]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculer la différence entre l'âge individuel et l'âge moyen dans le sous-groupe de sexe</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span> </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">dif_age_m =</span> agerev <span class="sc">-</span> age_m)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier le résultat</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>rp<span class="sc">$</span>dif_age_m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  -9.7516765  -9.0575909 -35.0575909  -7.0575909  -1.7516765  37.9424091
 [7] -34.0575909 -19.0575909   6.2483235  -9.0575909 -25.0575909 -24.0575909
[13]  25.9424091  30.2483235  15.9424091  22.2483235 -36.0575909  -0.7516765
[19]  -4.0575909   2.2483235 -17.7516765  10.9424091 -10.0575909 -12.7516765
[25]  -3.7516765 -11.0575909  54.2483235  -8.0575909  -8.7516765   5.2483235
[31] -24.7516765 -20.7516765   3.9424091  30.2483235  24.9424091  23.2483235
[37]  18.9424091  -2.0575909   3.2483235 -23.0575909   7.9424091  19.2483235
[43] -18.0575909  43.2483235 -19.0575909  -4.7516765  30.2483235  32.2483235
[49]  20.2483235  63.9424091
 [ reached getOption("max.print") -- omitted 193897 entries ]</code></pre>
</div>
</div>
</section>
</section>
<section id="exercices-4" class="level2">
<h2 class="anchored" data-anchor-id="exercices-4">Exercices</h2>
<ol type="1">
<li>Calculez l’âge moyen des immigré·es et des non-immigré·es</li>
<li>Calculez l’âge moyen des immigré·es et des non-immigré·es selon le sexe</li>
<li>Créez une colonne <code>age_immisexe</code> de l’âge moyen selon le statut d’immigration</li>
<li>Créez une colonne qui fais la différence entre l’âge individuel et l’âge moyen <code>age_immisexe</code></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize</span>(</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  rp,</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m =</span> <span class="fu">mean</span>(agerev),</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">.by =</span> immi</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  immi    age_m
1    2 35.14182
2    1 41.23992</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summarize</span>(</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  rp,</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_m =</span> <span class="fu">mean</span>(agerev),</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">.by =</span> <span class="fu">c</span>(immi, sexe)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  immi sexe    age_m
1    2    1 33.64813
2    2    2 36.46826
3    1    2 40.70833
4    1    1 41.86260</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_m =</span> <span class="fu">mean</span>(agerev),</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> <span class="fu">c</span>(immi, sexe)</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 4</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>rp <span class="ot">&lt;-</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>    rp,</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_age_m =</span> agerev <span class="sc">-</span> age_m,</span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Pour accéder à la page de documentation de fonctions comme <code>%in%</code>, on ne peut pas utiliser <code>?%in%</code>, qui renvoie une erreur. Vous pouvez faire <code>?"%in%"</code>, <code>help("%in%")</code> ou, dans ce cas, <code>?match</code>, car les deux fonctions sont documentées sur la même page d’aide.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>